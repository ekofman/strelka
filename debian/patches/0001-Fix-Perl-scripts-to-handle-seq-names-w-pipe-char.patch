From: apregier <aregier@genome.wustl.edu>
Date: Fri, 9 Aug 2013 16:53:20 -0500
Subject: [PATCH] Fix Perl scripts to handle seq names w pipe char

---
 src/perl/libexec/callSomaticVariants.pl   | 12 ++++++++++--
 src/perl/libexec/consolidateResults.pl    | 21 +++++++++++++++++----
 src/perl/libexec/filterSomaticVariants.pl | 12 ++++++++++--
 3 files changed, 37 insertions(+), 8 deletions(-)

diff --git a/src/perl/libexec/callSomaticVariants.pl b/src/perl/libexec/callSomaticVariants.pl
index 2cb51fd..522c179 100755
--- a/src/perl/libexec/callSomaticVariants.pl
+++ b/src/perl/libexec/callSomaticVariants.pl
@@ -69,7 +69,14 @@ pod2usage(2) unless(defined($chrom));
 pod2usage(2) unless(defined($binId));
 pod2usage(2) unless(defined($configFile));
 
-
+# Helper to fix bugs caused by sequence names that contain the | (pipe)
+# character. This does *not* sanitize other potentially troublesome
+# characters.
+sub substitutePipeChar {
+    my $string = shift;
+    $string =~ s/\|/_/g; # replace | with _
+    return $string;
+}
 
 #
 # check all fixed paths (not based on commandline arguments):
@@ -102,7 +109,8 @@ for (qw(minTier1Mapq isWriteRealignedBam binSize ssnvPrior sindelPrior
 }
 
 my $outDir = $config->{derived}{outDir};
-my $binDir = File::Spec->catdir($outDir,'chromosomes',$chrom,'bins',$binId);
+my $sanitizedChrom = substitutePipeChar($chrom);
+my $binDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom,'bins',$binId);
 checkDir($outDir,"output");
 checkDir($binDir,"output bin");
 
diff --git a/src/perl/libexec/consolidateResults.pl b/src/perl/libexec/consolidateResults.pl
index 71f7be0..de9c68f 100755
--- a/src/perl/libexec/consolidateResults.pl
+++ b/src/perl/libexec/consolidateResults.pl
@@ -69,6 +69,15 @@ GetOptions( "config=s" => \$configFile,
 pod2usage(2) if($help);
 pod2usage(2) unless(defined($configFile));
 
+# Helper to fix bugs caused by sequence names that contain the | (pipe)
+# character. This does *not* sanitize other potentially troublesome
+# characters.
+sub substitutePipeChar {
+    my $string = shift;
+    $string =~ s/\|/_/g; # replace | with _
+    return $string;
+}
+
 #
 # check fixed paths
 #
@@ -105,7 +114,8 @@ checkDir($outDir,"output");
 my $isWriteRealignedBam = $userconfig->{isWriteRealignedBam};
 
 for my $chrom (@chromOrder) {
-    my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+    my $sanitizedChrom = substitutePipeChar($chrom);
+    my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
     checkDir($chromDir,"input chromosome");
 
     next unless($isWriteRealignedBam);
@@ -139,7 +149,8 @@ sub concatenateVcfs($) {
     # loop over all chroms once to create the header, and one more time for all the data:
     my $headervcf;
     for my $chrom (@chromOrder) {
-        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+        my $sanitizedChrom = substitutePipeChar($chrom);
+        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
         my $iFile = File::Spec->catfile($chromDir,$fileName);
         checkFile($iFile);
 
@@ -174,7 +185,8 @@ sub concatenateVcfs($) {
     $headervcf->close();
 
     for my $chrom (@chromOrder) {
-        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+        my $sanitizedChrom = substitutePipeChar($chrom);
+        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
         my $iFile = File::Spec->catfile($chromDir,$fileName);
 
         open(my $iFH,'<',"$iFile")
@@ -231,7 +243,8 @@ sub consolidateBam($) {
 
     my @bamList;
     for my $chrom (@chromOrder) {
-        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+        my $sanitizedChrom = substitutePipeChar($chrom);
+        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
 
         my $chromSizeKey = "chrom_" . $chrom . "_size";
         my $binList = getBinList($config->{derived}{$chromSizeKey},$userconfig->{binSize});
diff --git a/src/perl/libexec/filterSomaticVariants.pl b/src/perl/libexec/filterSomaticVariants.pl
index 93a5fd1..149513c 100755
--- a/src/perl/libexec/filterSomaticVariants.pl
+++ b/src/perl/libexec/filterSomaticVariants.pl
@@ -64,7 +64,14 @@ pod2usage(2) if($help);
 pod2usage(2) unless(defined($chrom));
 pod2usage(2) unless(defined($configFile));
 
-
+# Helper to fix bugs caused by sequence names that contain the | (pipe)
+# character. This does *not* sanitize other potentially troublesome
+# characters.
+sub substitutePipeChar {
+    my $string = shift;
+    $string =~ s/\|/_/g; # replace | with _
+    return $string;
+}
 
 #
 # read config and validate values
@@ -87,7 +94,8 @@ for (qw(binSize ssnvQuality_LowerBound sindelQuality_LowerBound
 }
 
 my $outDir = $config->{derived}{outDir};
-my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+my $sanitizedChrom = substitutePipeChar($chrom);
+my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
 checkDir($outDir,"output");
 checkDir($chromDir,"output chromosome");
 
-- 
