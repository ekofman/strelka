From: Ian Ferguson <iferguso@genome.wustl.edu>
Date: Tue, 7 May 2013 17:31:10 -0500
Subject: [PATCH] Fix Perl scripts to handle seq names w/ pipe char

---
 strelka/scripts/.configureStrelkaWorkflow.pl | 31 ++++++++++++++++++++--------
 strelka/scripts/callSomaticVariants.pl       | 12 +++++++++--
 strelka/scripts/consolidateResults.pl        | 21 +++++++++++++++----
 strelka/scripts/filterSomaticVariants.pl     | 12 +++++++++--
 4 files changed, 59 insertions(+), 17 deletions(-)

diff --git a/strelka/scripts/.configureStrelkaWorkflow.pl b/strelka/scripts/.configureStrelkaWorkflow.pl
index 46e0197..d62a2a9 100755
--- a/strelka/scripts/.configureStrelkaWorkflow.pl
+++ b/strelka/scripts/.configureStrelkaWorkflow.pl
@@ -108,6 +108,14 @@ GetOptions( "tumor=s" => \$tumorBam,
 usage() if($help);
 usage() unless($argCount);
 
+# Helper to fix bugs caused by sequence names that contain the | (pipe)
+# character. This does *not* sanitize other potentially troublesome
+# characters.
+sub substitutePipeChar {
+    my $string = shift;
+    $string =~ s/\|/_/g; # replace | with _
+    return $string;
+}
 
 #
 # Validate input conditions:
@@ -357,7 +365,8 @@ if($config->{user}{isWriteRealignedBam}) {
 my $chromRootDir = File::Spec->catdir($outDir,'chromosomes');
 checkMakeDir($chromRootDir);
 for my $chrom (@chroms) {
-    my $chromDir = File::Spec->catdir($chromRootDir,$chrom);
+    my $sanitizedChrom = substitutePipeChar($chrom);
+    my $chromDir = File::Spec->catdir($chromRootDir,$sanitizedChrom);
     checkMakeDir($chromDir);
 
     my $chromRef = $chromInfo{$chrom};
@@ -461,11 +470,13 @@ ENDE
 
 for my $chrom (@chroms) {
 
+    my $sanitizedChrom = substitutePipeChar($chrom);
+
     print $MAKEFH <<ENDE;
-chrom_${chrom}_task := \$(call get_chrom_task,$chrom)
-\$(finish_task): \$(chrom_${chrom}_task)
-\$(chrom_${chrom}_task):
-	\$(filter_script) --config=\$(config_file) --chrom=$chrom && touch \$@
+chrom_${sanitizedChrom}_task := \$(call get_chrom_task,$sanitizedChrom)
+\$(finish_task): \$(chrom_${sanitizedChrom}_task)
+\$(chrom_${sanitizedChrom}_task):
+	\$(filter_script) --config=\$(config_file) --chrom='$chrom' && touch \$@
 
 ENDE
 
@@ -480,11 +491,13 @@ ENDE
 for my $chrom (@chroms) {
     for my $bin (@{$chromInfo{$chrom}{binList}}) {
 
+        my $sanitizedChrom = substitutePipeChar($chrom);
+
 print $MAKEFH <<ENDE;
-chrom_${chrom}_bin_${bin}_task := \$(call get_bin_task,$chrom,$bin)
-\$(chrom_${chrom}_task): \$(chrom_${chrom}_bin_${bin}_task)
-\$(chrom_${chrom}_bin_${bin}_task):
-	\$(call_script) --config=\$(config_file) --chrom=$chrom --bin=$bin && touch \$@
+chrom_${sanitizedChrom}_bin_${bin}_task := \$(call get_bin_task,$sanitizedChrom,$bin)
+\$(chrom_${sanitizedChrom}_task): \$(chrom_${sanitizedChrom}_bin_${bin}_task)
+\$(chrom_${sanitizedChrom}_bin_${bin}_task):
+	\$(call_script) --config=\$(config_file) --chrom='$chrom' --bin=$bin && touch \$@
 
 ENDE
 
diff --git a/strelka/scripts/callSomaticVariants.pl b/strelka/scripts/callSomaticVariants.pl
index 9df959a..1ab35c3 100755
--- a/strelka/scripts/callSomaticVariants.pl
+++ b/strelka/scripts/callSomaticVariants.pl
@@ -61,7 +61,14 @@ pod2usage(2) unless(defined($chrom));
 pod2usage(2) unless(defined($binId));
 pod2usage(2) unless(defined($configFile));
 
-
+# Helper to fix bugs caused by sequence names that contain the | (pipe)
+# character. This does *not* sanitize other potentially troublesome
+# characters.
+sub substitutePipeChar {
+    my $string = shift;
+    $string =~ s/\|/_/g; # replace | with _
+    return $string;
+}
 
 #
 # check all fixed paths (not based on commandline arguments):
@@ -100,7 +107,8 @@ for (qw(isWriteRealignedBam binSize ssnvPrior sindelPrior
 }
 
 my $outDir = $config->{derived}{outDir};
-my $binDir = File::Spec->catdir($outDir,'chromosomes',$chrom,'bins',$binId);
+my $sanitizedChrom = substitutePipeChar($chrom);
+my $binDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom,'bins',$binId);
 checkDir($outDir,"output");
 checkDir($binDir,"output bin");
 
diff --git a/strelka/scripts/consolidateResults.pl b/strelka/scripts/consolidateResults.pl
index 383ff76..52076ea 100755
--- a/strelka/scripts/consolidateResults.pl
+++ b/strelka/scripts/consolidateResults.pl
@@ -64,6 +64,15 @@ GetOptions( "config=s" => \$configFile,
 pod2usage(2) if($help);
 pod2usage(2) unless(defined($configFile));
 
+# Helper to fix bugs caused by sequence names that contain the | (pipe)
+# character. This does *not* sanitize other potentially troublesome
+# characters.
+sub substitutePipeChar {
+    my $string = shift;
+    $string =~ s/\|/_/g; # replace | with _
+    return $string;
+}
+
 #
 # check fixed paths
 #
@@ -104,7 +113,8 @@ checkDir($outDir,"output");
 my $isWriteRealignedBam = $userconfig->{isWriteRealignedBam};
 
 for my $chrom (@chromOrder) {
-    my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+    my $sanitizedChrom = substitutePipeChar($chrom);
+    my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
     checkDir($chromDir,"input chromosome");
 
     next unless($isWriteRealignedBam);
@@ -138,7 +148,8 @@ sub concatenateVcfs($) {
     # loop over all chroms once to create the header, and one more time for all the data:
     my $headervcf;
     for my $chrom (@chromOrder) {
-        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+        my $sanitizedChrom = substitutePipeChar($chrom);
+        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
         my $iFile = File::Spec->catfile($chromDir,$fileName);
         checkFile($iFile);
 
@@ -173,7 +184,8 @@ sub concatenateVcfs($) {
     $headervcf->close();
 
     for my $chrom (@chromOrder) {
-        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+        my $sanitizedChrom = substitutePipeChar($chrom);
+        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
         my $iFile = File::Spec->catfile($chromDir,$fileName);
 
         open(my $iFH,'<',"$iFile")
@@ -230,7 +242,8 @@ sub consolidateBam($) {
 
     my @bamList;
     for my $chrom (@chromOrder) {
-        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+        my $sanitizedChrom = substitutePipeChar($chrom);
+        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
 
         my $chromSizeKey = "chrom_" . $chrom . "_size";
         my $binList = getBinList($config->{derived}{$chromSizeKey},$userconfig->{binSize});
diff --git a/strelka/scripts/filterSomaticVariants.pl b/strelka/scripts/filterSomaticVariants.pl
index 5494e9d..344dd56 100755
--- a/strelka/scripts/filterSomaticVariants.pl
+++ b/strelka/scripts/filterSomaticVariants.pl
@@ -64,7 +64,14 @@ pod2usage(2) if($help);
 pod2usage(2) unless(defined($chrom));
 pod2usage(2) unless(defined($configFile));
 
-
+# Helper to fix bugs caused by sequence names that contain the | (pipe)
+# character. This does *not* sanitize other potentially troublesome
+# characters.
+sub substitutePipeChar {
+    my $string = shift;
+    $string =~ s/\|/_/g; # replace | with _
+    return $string;
+}
 
 #
 # read config and validate values
@@ -87,7 +94,8 @@ for (qw(binSize ssnvQuality_LowerBound sindelQuality_LowerBound
 }
 
 my $outDir = $config->{derived}{outDir};
-my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+my $sanitizedChrom = substitutePipeChar($chrom);
+my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
 checkDir($outDir,"output");
 checkDir($chromDir,"output chromosome");
 
-- 
