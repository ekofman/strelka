From: apregier <aregier@genome.wustl.edu>
Date: Fri, 9 Aug 2013 16:53:20 -0500
Subject: [PATCH] Fix Perl scripts to handle seq names w pipe char

---
 src/perl/bin/configureStrelkaWorkflow.pl  | 33 ++++++++++++++++++++-----------
 src/perl/libexec/callSomaticVariants.pl   | 12 +++++++++--
 src/perl/libexec/consolidateResults.pl    | 21 ++++++++++++++++----
 src/perl/libexec/filterSomaticVariants.pl | 12 +++++++++--
 4 files changed, 59 insertions(+), 19 deletions(-)

diff --git a/src/perl/bin/configureStrelkaWorkflow.pl b/src/perl/bin/configureStrelkaWorkflow.pl
index 5c66887..175791d 100755
--- a/src/perl/bin/configureStrelkaWorkflow.pl
+++ b/src/perl/bin/configureStrelkaWorkflow.pl
@@ -97,6 +97,15 @@ my $cmdline = join(' ',$0,@ARGV);
 sub usage() { pod2usage(-verbose => 1,
                         -exitval => 2); }
 
+# Helper to fix bugs caused by sequence names that contain the | (pipe)
+# character. This does *not* sanitize other potentially troublesome
+# characters.
+sub substitutePipeChar {
+    my $string = shift;
+    $string =~ s/\|/_/g; # replace | with _
+    return $string;
+}
+
 #
 # user configuration:
 #
@@ -371,7 +380,8 @@ for my $chrom (@chroms) {
     checkMakeDir($binRootDir);
 
     for my $binId ( @{$chromRef->{binList}} ) {
-        my $binDir = File::Spec->catdir($binRootDir,$binId);
+        my $sanitizedChrom = substitutePipeChar($chrom);
+        my $binDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom,'bins',$binId);
         checkMakeDir($binDir);
     }
 }
@@ -463,12 +473,12 @@ $(finish_task):
 ENDE
 
 for my $chrom (@chroms) {
-
+    my $sanitizedChrom = substitutePipeChar($chrom);
     print $MAKEFH <<ENDE;
-chrom_${chrom}_task := \$(call get_chrom_task,$chrom)
-\$(finish_task): \$(chrom_${chrom}_task)
-\$(chrom_${chrom}_task):
-	\$(filter_script) --config=\$(config_file) --chrom=$chrom && touch \$@
+chrom_${sanitizedChrom}_task := \$(call get_chrom_task,$sanitizedChrom)
+\$(finish_task): \$(chrom_${sanitizedChrom}_task)
+\$(chrom_${sanitizedChrom}_task):
+	\$(filter_script) --config=\$(config_file) --chrom='$chrom' && touch \$@
 
 ENDE
 
@@ -480,15 +490,16 @@ print $MAKEFH <<ENDE;
 #
 ENDE
 
+
 for my $chrom (@chroms) {
     for my $bin (@{$chromInfo{$chrom}{binList}}) {
 
+       my $sanitizedChrom = substitutePipeChar($chrom);
 print $MAKEFH <<ENDE;
-chrom_${chrom}_bin_${bin}_task := \$(call get_bin_task,$chrom,$bin)
-\$(chrom_${chrom}_task): \$(chrom_${chrom}_bin_${bin}_task)
-\$(chrom_${chrom}_bin_${bin}_task):
-	\$(call_script) --config=\$(config_file) --chrom=$chrom --bin=$bin && touch \$@
-
+chrom_${sanitizedChrom}_bin_${bin}_task := \$(call get_bin_task,$sanitizedChrom,$bin)
+\$(chrom_${sanitizedChrom}_task): \$(chrom_${sanitizedChrom}_bin_${bin}_task)
+\$(chrom_${sanitizedChrom}_bin_${bin}_task):
+	\$(call_script) --config=\$(config_file) --chrom='$chrom' --bin=$bin && touch \$@
 ENDE
 
     }
diff --git a/src/perl/libexec/callSomaticVariants.pl b/src/perl/libexec/callSomaticVariants.pl
index 2cb51fd..522c179 100755
--- a/src/perl/libexec/callSomaticVariants.pl
+++ b/src/perl/libexec/callSomaticVariants.pl
@@ -69,7 +69,14 @@ pod2usage(2) unless(defined($chrom));
 pod2usage(2) unless(defined($binId));
 pod2usage(2) unless(defined($configFile));
 
-
+# Helper to fix bugs caused by sequence names that contain the | (pipe)
+# character. This does *not* sanitize other potentially troublesome
+# characters.
+sub substitutePipeChar {
+    my $string = shift;
+    $string =~ s/\|/_/g; # replace | with _
+    return $string;
+}
 
 #
 # check all fixed paths (not based on commandline arguments):
@@ -102,7 +109,8 @@ for (qw(minTier1Mapq isWriteRealignedBam binSize ssnvPrior sindelPrior
 }
 
 my $outDir = $config->{derived}{outDir};
-my $binDir = File::Spec->catdir($outDir,'chromosomes',$chrom,'bins',$binId);
+my $sanitizedChrom = substitutePipeChar($chrom);
+my $binDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom,'bins',$binId);
 checkDir($outDir,"output");
 checkDir($binDir,"output bin");
 
diff --git a/src/perl/libexec/consolidateResults.pl b/src/perl/libexec/consolidateResults.pl
index 71f7be0..de9c68f 100755
--- a/src/perl/libexec/consolidateResults.pl
+++ b/src/perl/libexec/consolidateResults.pl
@@ -69,6 +69,15 @@ GetOptions( "config=s" => \$configFile,
 pod2usage(2) if($help);
 pod2usage(2) unless(defined($configFile));
 
+# Helper to fix bugs caused by sequence names that contain the | (pipe)
+# character. This does *not* sanitize other potentially troublesome
+# characters.
+sub substitutePipeChar {
+    my $string = shift;
+    $string =~ s/\|/_/g; # replace | with _
+    return $string;
+}
+
 #
 # check fixed paths
 #
@@ -105,7 +114,8 @@ checkDir($outDir,"output");
 my $isWriteRealignedBam = $userconfig->{isWriteRealignedBam};
 
 for my $chrom (@chromOrder) {
-    my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+    my $sanitizedChrom = substitutePipeChar($chrom);
+    my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
     checkDir($chromDir,"input chromosome");
 
     next unless($isWriteRealignedBam);
@@ -139,7 +149,8 @@ sub concatenateVcfs($) {
     # loop over all chroms once to create the header, and one more time for all the data:
     my $headervcf;
     for my $chrom (@chromOrder) {
-        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+        my $sanitizedChrom = substitutePipeChar($chrom);
+        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
         my $iFile = File::Spec->catfile($chromDir,$fileName);
         checkFile($iFile);
 
@@ -174,7 +185,8 @@ sub concatenateVcfs($) {
     $headervcf->close();
 
     for my $chrom (@chromOrder) {
-        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+        my $sanitizedChrom = substitutePipeChar($chrom);
+        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
         my $iFile = File::Spec->catfile($chromDir,$fileName);
 
         open(my $iFH,'<',"$iFile")
@@ -231,7 +243,8 @@ sub consolidateBam($) {
 
     my @bamList;
     for my $chrom (@chromOrder) {
-        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+        my $sanitizedChrom = substitutePipeChar($chrom);
+        my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
 
         my $chromSizeKey = "chrom_" . $chrom . "_size";
         my $binList = getBinList($config->{derived}{$chromSizeKey},$userconfig->{binSize});
diff --git a/src/perl/libexec/filterSomaticVariants.pl b/src/perl/libexec/filterSomaticVariants.pl
index 93a5fd1..149513c 100755
--- a/src/perl/libexec/filterSomaticVariants.pl
+++ b/src/perl/libexec/filterSomaticVariants.pl
@@ -64,7 +64,14 @@ pod2usage(2) if($help);
 pod2usage(2) unless(defined($chrom));
 pod2usage(2) unless(defined($configFile));
 
-
+# Helper to fix bugs caused by sequence names that contain the | (pipe)
+# character. This does *not* sanitize other potentially troublesome
+# characters.
+sub substitutePipeChar {
+    my $string = shift;
+    $string =~ s/\|/_/g; # replace | with _
+    return $string;
+}
 
 #
 # read config and validate values
@@ -87,7 +94,8 @@ for (qw(binSize ssnvQuality_LowerBound sindelQuality_LowerBound
 }
 
 my $outDir = $config->{derived}{outDir};
-my $chromDir = File::Spec->catdir($outDir,'chromosomes',$chrom);
+my $sanitizedChrom = substitutePipeChar($chrom);
+my $chromDir = File::Spec->catdir($outDir,'chromosomes',$sanitizedChrom);
 checkDir($outDir,"output");
 checkDir($chromDir,"output chromosome");
 
-- 
